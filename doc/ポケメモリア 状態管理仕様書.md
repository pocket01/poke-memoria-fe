# ポケメモリア 状態管理仕様書

## 概要

本書では、ポケメモリアのWebアプリケーションにおける状態管理（State Management）の仕様を定義する。ウィザード形式で複数のページをまたいで履歴書データを保持するため、React Context APIを活用したシンプルかつ拡張性の高い設計を採用する。

## 基本方針

### 採用技術

- **React Context API**: アプリケーション全体で状態を共有
- **localStorage**: ブラウザを閉じてもデータが消えないよう永続化

### 採用理由

- 小規模〜中規模アプリケーションに最適
- Redux等の複雑なライブラリと比較して学習コストが低い
- 1日1時間の限られた開発時間で効率的に実装可能

## データ構造

### ResumeData型定義

履歴書データの型定義：

```typescript
type ResumeData = {
  // テーマ選択（表示スタイル）
  theme: 'paper' | 'neo_gb' | 'retro_rg';
  
  // 初めての冒険（最初にプレイした作品）
  originTitleId: string;
  
  // プレイ履歴（作品とステータス）
  history: Array<{
    titleId: string;
    status: 'release' | 'later' | 'remake';
  }>;
  
  // 相棒ポケモン（思い出のポケモン）
  partners: Array<{
    pokemonId: number;
    name: string;
    comment: string;
  }>;
  
  // トレーナー情報
  trainerInfo: {
    name: string;           // トレーナー名
    startYear: string;      // ポケモンを始めた年
    playCount: number;      // プレイ作品数
    tags: string[];         // 属性タグ
    message: string;        // 自由記述メッセージ
  };
};
```

## Context実装

### ディレクトリ構成

状態管理に関連するファイルの配置：

```text
stores/
└── resumeStore.ts        # Zustand等での状態管理ロジック

app/create/
└── layout.tsx            # ResumeProvider配置
```

> **Note**: プロジェクト全体のディレクトリ構成については [README.md](../README.md#-ディレクトリ構成) を参照してください。
>
> 本プロジェクトでは、Context APIの代わりに `stores/` ディレクトリに配置するZustand等のストア管理を採用する方針です。

### ResumeContext構成

```typescript
// context/ResumeContext.tsx

interface ResumeContextType {
  data: ResumeData;
  updateData: (partial: Partial<ResumeData>) => void;
  resetData: () => void;
}

// Provider コンポーネント
// - アプリケーション全体を包む
// - localStorage との同期処理を含む
// - 初期データの設定
```

### Provider配置

```typescript
// app/create/layout.tsx

export default function CreateLayout({ children }) {
  return (
    <ResumeProvider>
      {children}
    </ResumeProvider>
  );
}
```

## 状態管理の仕様

### 1. データアクセス

各ページコンポーネントから`useResumeContext`フックを通じてアクセス：

```typescript
const { data, updateData } = useResumeContext();
```

### 2. データ更新

部分的な更新をサポート：

```typescript
// 例: Step 1で初めての冒険を保存
updateData({ originTitleId: 'ruby-sapphire' });

// 例: Step 3で相棒ポケモンを追加
updateData({
  partners: [
    ...data.partners,
    { pokemonId: 25, name: 'ピカチュウ', comment: '最初の相棒' }
  ]
});
```

### 3. データ永続化

- **自動保存**: `updateData`呼び出し時に自動的に`localStorage`へ保存
- **自動復元**: アプリケーション起動時に`localStorage`からデータを読み込み
- **キー名**: `poke-memoria-resume-data`

### 4. データリセット

プレビュー画面での保存完了後や、新規作成時にデータをリセット：

```typescript
resetData();
```

## 実装のポイント

### 1. localStorageとの同期

ブラウザを閉じても作業を中断・再開できるよう、Context内で`localStorage`との同期を実装：

- データ更新時に`localStorage`へ保存
- Provider初期化時に`localStorage`から復元
- エラーハンドリング（localStorage使用不可時の対応）

### 2. 型安全性

TypeScriptの型定義により、データ構造の整合性を保証：

- 各ステップでのデータ入力ミスを防止
- IDEの補完機能を活用した開発効率の向上

### 3. 拡張性

将来的な機能追加に対応できる設計：

- 新しいステップの追加が容易
- データ構造の拡張が柔軟

## 技術仕様

- **状態管理**: React Context API
- **永続化**: localStorage API
- **型定義**: TypeScript
- **データフォーマット**: JSON

## セキュリティ考慮事項

- localStorageに保存されるデータは個人情報を含む可能性があるため、取り扱いに注意
- XSS対策として、ユーザー入力データは適切にサニタイズ

## 備考

- Contextの雛形を先に作成することで、各ページのUI作成中にデータ保存を意識せず開発可能
- 「次へ」ボタンの共通化により、各ページの実装を簡素化
